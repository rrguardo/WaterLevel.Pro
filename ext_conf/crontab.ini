SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# alert workers
*/3 * * * * cd /app && /bin/bash -lc 'source /app/docker/cron-env.sh || true; python email_alerts_cron.py >> /var/log/cron/email_alerts_cron.log 2>&1'
*/3 * * * * cd /app && /bin/bash -lc 'source /app/docker/cron-env.sh || true; python sms_alerts_cron.py >> /var/log/cron/sms_alerts_cron.log 2>&1'

# demo S1 simulator: run every 30s (00,30) using .env keys
* * * * * cd /app && /bin/bash -lc 'source /app/docker/cron-env.sh || true; for i in 1 2; do python scripts/s1_demo_device_service.py --once --base-url http://nginx --host-header "${WLP_API_SERVER_NAME:-api.localhost}" >> /var/log/cron/s1_demo_device_service.log 2>&1; if [ "$i" -lt 2 ]; then sleep 30; fi; done'

# demo relay simulator: run every 30s (00,30) using .env keys
* * * * * cd /app && /bin/bash -lc 'source /app/docker/cron-env.sh || true; for i in 1 2; do python scripts/r1_demo_relay_service.py --once --base-url http://nginx --host-header "${WLP_API_SERVER_NAME:-api.localhost}" >> /var/log/cron/r1_demo_relay_service.log 2>&1; if [ "$i" -lt 2 ]; then sleep 30; fi; done'

# access reports from nginx logs (shared volume)
0 6 * * * /bin/bash -lc 'source /app/docker/cron-env.sh || true; [ -f /var/log/nginx/wlp_web_access.log.1 ] && goaccess /var/log/nginx/wlp_web_access.log.1 -o "/app/reports/WEB_$(date --date='yesterday' +\%Y-\%m-\%d).html" --log-format=COMBINED >> /var/log/cron/reports_cron.log 2>&1'
0 8 * * * /bin/bash -lc 'source /app/docker/cron-env.sh || true; [ -f /var/log/nginx/wlp_api_access.log.1 ] && goaccess /var/log/nginx/wlp_api_access.log.1 -o "/app/reports/API_$(date --date='yesterday' +\%Y-\%m-\%d).html" --log-format=COMBINED >> /var/log/cron/reports_cron.log 2>&1'
0 7 * * * /bin/bash -lc 'source /app/docker/cron-env.sh || true; ls /var/log/nginx/wlp_web_access.log.*.gz >/dev/null 2>&1 && zcat /var/log/nginx/wlp_web_access.log.*.gz | goaccess -o /app/reports/WEB_FULL.html --log-format=COMBINED - >> /var/log/cron/reports_cron.log 2>&1'
20 7 * * * /bin/bash -lc 'source /app/docker/cron-env.sh || true; ls /var/log/nginx/wlp_api_access.log.*.gz >/dev/null 2>&1 && zcat /var/log/nginx/wlp_api_access.log.*.gz | goaccess -o /app/reports/API_FULL.html --log-format=COMBINED - >> /var/log/cron/reports_cron.log 2>&1'

# retention
0 2 * * * /bin/bash -lc 'source /app/docker/cron-env.sh || true; find /app/reports -type f -mtime +14 -delete >> /var/log/cron/reports_cron.log 2>&1'
