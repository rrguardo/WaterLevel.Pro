version: 1
project:
  name: wlp
  summary: Water level platform with Flask web/api, Redis cache, SQLite persistence, Docker runtime, and Nginx TLS edge.
runtime:
  container_orchestrator: docker-compose
  compose_file: docker/docker-compose.yml
  services:
    - name: app
      role: flask-web-api-plus-redis
      upstreams:
        web: app:8000
        api: app:8001
    - name: nginx
      role: tls-edge-and-host-routing
      public_ports: [80, 443]
    - name: cron
      role: scheduled-alerts-and-reports
      schedule_file: ext_conf/crontab.ini
    - name: goaccess
      role: live-report-generator
entrypoints:
  web: https://<WLP_SERVER_NAME>
  api: https://<WLP_API_SERVER_NAME>
device_api_contracts:
  sensor_s1_update:
    endpoint: /update
    method: GET
    auth: private key query param `key`
    query_params: [key, distance, voltage]
    request_headers: [FW-Version, RSSI]
    success:
      body: OK
      response_headers: [fw-version, wpl]
  relay_r1_update:
    endpoint: /relay-update
    method: GET
    auth: private key query param `key`
    query_params: [key, status]
    request_headers: [FW-Version, RSSI, EVENTS]
    success:
      body: OK
      response_headers:
        - fw-version
        - pool-time
        - ACTION
        - percent
        - event-time
        - current-time
        - distance
        - ALGO
        - SAFE_MODE
        - START_LEVEL
        - END_LEVEL
        - AUTO_OFF
        - AUTO_ON
        - MIN_FLOW_MM_X_MIN
        - BLIND_DISTANCE
        - HOURS_OFF
simulators:
  sensor_s1: scripts/s1_demo_device_service.py
  relay_r1: scripts/r1_demo_relay_service.py
source_of_truth:
  architecture: docs/ai/ARCHITECTURE.md
  operations: docs/ai/OPERATIONS_PLAYBOOK.md
  change_checklist: docs/ai/CHANGE_CHECKLIST.md
  deploy_user_template: docs/ai/DEPLOY_AGENT_INPUT_TEMPLATE.yaml
  deploy_chat_prompt_template: docs/ai/DEPLOY_CHAT_PROMPT_TEMPLATE.md
  deploy_vps_guide: docs/DEPLOY_VPS_AI_AGENT_README.md
  compose: docker/docker-compose.yml
  nginx_template: ext_conf/docker/nginx.conf.template
  smoke_test: scripts/docker_smoke_test.sh
env_contract:
  required_high_signal:
    - APP_DOMAIN
    - API_DOMAIN
    - WLP_SERVER_NAME
    - WLP_API_SERVER_NAME
    - WLP_WEB_UPSTREAM
    - WLP_API_UPSTREAM
    - WLP_SSL_CERT_PATH
    - WLP_SSL_KEY_PATH
    - REDIS_HOST
    - REDIS_PORT
    - DATABASE_URL
validation:
  primary_smoke: ./scripts/docker_smoke_test.sh
  local_ci: gitlab-ci-local --force-shell-executor docker_smoke_test
constraints:
  - Keep API under subdomain of same base domain.
  - Keep SQLite single-node assumptions unless explicitly requested.
  - Keep ingress centralized in nginx.
